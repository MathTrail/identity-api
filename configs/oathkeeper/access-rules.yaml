# Ory Oathkeeper - Access Rules Reference
# These rules are embedded in values/oathkeeper-values.yaml for deployment.
# This file serves as the authoritative source for documentation.

# Health endpoints - no authentication needed
- id: "mathtrail-health-rule"
  upstream:
    url: "http://identity-ui:8080"
  match:
    methods: ["GET"]
    url: "<http|https>://<.*>/health/<.*>"
  authenticators:
    - handler: noop
  authorizer:
    handler: allow
  mutators:
    - handler: noop

# Auth UI - anonymous access (login/registration forms)
- id: "mathtrail-auth-ui-rule"
  upstream:
    url: "http://identity-ui:8080"
  match:
    methods: ["GET", "POST"]
    url: "<http|https>://<.*>/auth/<.*>"
  authenticators:
    - handler: anonymous
  authorizer:
    handler: allow
  mutators:
    - handler: noop

# API endpoints - bearer token required, X-User-ID injected
- id: "mathtrail-api-rule"
  upstream:
    url: "http://mathtrail-mentor:8080"
  match:
    methods: ["GET", "POST", "PUT", "DELETE"]
    url: "<http|https>://<.*>/api/<.*>"
  authenticators:
    - handler: bearer_token
  authorizer:
    handler: allow
  mutators:
    - handler: header

# Mentor service - authenticated access with ReBAC check
- id: "mathtrail-mentor-rule"
  upstream:
    url: "http://mathtrail-mentor:8080"
  match:
    methods: ["GET", "POST"]
    url: "<http|https>://<.*>/mentor/<.*>"
  authenticators:
    - handler: bearer_token
  authorizers:
    - handler: remote_json
      config:
        remote: http://keto-read:4466/relation-tuples/check
  mutators:
    - handler: header
      config:
        headers:
          X-User-ID: "{{ print .Subject }}"
          X-User-Role: "{{ print .Extra.role }}"
