# Ory Oathkeeper - Zero Trust Identity & Access Proxy
# Local development configuration

oathkeeper:
  config:
    authenticators:
      bearer_token:
        enabled: true
        config:
          check_session_url: http://kratos-public:4433/sessions/whoami
          preserve_path: true
          extra_from: "@this"
          subject_from: "identity.id"
          force_method: GET
      anonymous:
        enabled: true
      noop:
        enabled: true

    authorizers:
      remote_json:
        enabled: true
        config:
          remote: http://keto-read:4466/relation-tuples/check
          payload: |
            {
              "namespace": "ClassGroup",
              "object": "{{ print .MatchContext.RegexpCaptureGroups }}",
              "relation": "members",
              "subject_id": "{{ print .Subject }}"
            }
      allow:
        enabled: true

    mutators:
      header:
        enabled: true
        config:
          headers:
            X-User-ID: "{{ print .Subject }}"
      noop:
        enabled: true

    serve:
      proxy:
        port: 4455
      api:
        port: 4456

    access_rules:
      repositories:
        - file:///etc/rules/access-rules.yaml

    log:
      level: info

  accessRules: |
    - id: "mathtrail-health-rule"
      upstream:
        url: "http://identity-ui:8080"
      match:
        methods: ["GET"]
        url: "<http|https>://<.*>/health/<.*>"
      authenticators:
        - handler: noop
      authorizer:
        handler: allow
      mutators:
        - handler: noop

    - id: "mathtrail-auth-ui-rule"
      upstream:
        url: "http://identity-ui:8080"
      match:
        methods: ["GET", "POST"]
        url: "<http|https>://<.*>/auth/<.*>"
      authenticators:
        - handler: anonymous
      authorizer:
        handler: allow
      mutators:
        - handler: noop

    - id: "mathtrail-api-rule"
      upstream:
        url: "http://mathtrail-mentor:8080"
      match:
        methods: ["GET", "POST", "PUT", "DELETE"]
        url: "<http|https>://<.*>/api/<.*>"
      authenticators:
        - handler: bearer_token
      authorizer:
        handler: allow
      mutators:
        - handler: header

  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi
