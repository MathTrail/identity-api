# Ory Oathkeeper - Zero Trust Identity & Access Proxy
# Local development configuration

oathkeeper:
  config:
    authenticators:
      cookie_session:
        enabled: true
        config:
          check_session_url: http://kratos-public:4433/sessions/whoami
          preserve_path: true
          extra_from: "@this"
          subject_from: "identity.id"
          force_method: GET
          only:
            - ory_kratos_session
      bearer_token:
        enabled: true
        config:
          check_session_url: http://kratos-public:4433/sessions/whoami
          preserve_path: true
          extra_from: "@this"
          subject_from: "identity.id"
          force_method: GET
      anonymous:
        enabled: true
      noop:
        enabled: true

    authorizers:
      remote_json:
        enabled: true
        config:
          remote: http://keto-read:4466/relation-tuples/check
          payload: |
            {
              "namespace": "ClassGroup",
              "object": "{{ print .MatchContext.RegexpCaptureGroups }}",
              "relation": "members",
              "subject_id": "{{ print .Subject }}"
            }
      allow:
        enabled: true

    mutators:
      header:
        enabled: true
        config:
          headers:
            X-User-ID: "{{ print .Subject }}"
      noop:
        enabled: true

    serve:
      proxy:
        port: 4455
      api:
        port: 4456

    access_rules:
      repositories:
        - file:///etc/rules/access-rules.yaml

    log:
      level: info

  accessRules: |
    - id: "mathtrail-health-rule"
      upstream:
        url: "http://identity-ui:8080"
      match:
        methods: ["GET"]
        url: "<http|https>://<.*>/health/<.*>"
      authenticators:
        - handler: noop
      authorizer:
        handler: allow
      mutators:
        - handler: noop

    - id: "mathtrail-auth-ui-rule"
      upstream:
        url: "http://identity-ui:8080"
      match:
        methods: ["GET", "POST"]
        url: "<http|https>://<.*>/auth/<.*>"
      authenticators:
        - handler: anonymous
      authorizer:
        handler: allow
      mutators:
        - handler: noop

    - id: "mathtrail-mentor-swagger-rule"
      upstream:
        url: "http://mathtrail-mentor:8080"
        strip_path: "/swagger/mentor"
      match:
        methods: ["GET"]
        url: "<http|https>://<.*>/swagger/mentor/<.*>"
      authenticators:
        - handler: cookie_session
      authorizer:
        handler: allow
      mutators:
        - handler: noop

    - id: "mathtrail-api-rule"
      upstream:
        url: "http://mathtrail-mentor:8080"
      match:
        methods: ["GET", "POST", "PUT", "DELETE"]
        url: "<http|https>://<.*>/api/<.*>"
      authenticators:
        - handler: cookie_session
        - handler: bearer_token
      authorizer:
        handler: allow
      mutators:
        - handler: header

    - id: "mathtrail-grafana-rule"
      upstream:
        url: "http://lgtm-grafana.monitoring.svc.cluster.local:80"
        strip_path: "/observability/grafana"
      match:
        methods: ["GET", "POST", "PUT", "DELETE", "PATCH"]
        url: "<http|https>://<.*>/observability/grafana/<.*>"
      authenticators:
        - handler: cookie_session
      authorizer:
        handler: remote_json
        config:
          remote: http://keto-read:4466/relation-tuples/check
          payload: |
            {
              "namespace": "Monitoring",
              "object": "ui",
              "relation": "viewer",
              "subject_id": "{{ print .Subject }}"
            }
      mutators:
        - handler: header
          config:
            headers:
              X-Webauth-User: "{{ print .Extra.identity.traits.email }}"
              X-User-ID: "{{ print .Subject }}"
              X-Webauth-Role: "{{ if or (eq .Extra.identity.traits.role \"admin\") (eq .Extra.identity.traits.role \"mentor\") }}Admin{{ else if eq .Extra.identity.traits.role \"teacher\" }}Editor{{ else }}Viewer{{ end }}"

    - id: "mathtrail-pyroscope-rule"
      upstream:
        url: "http://pyroscope.monitoring.svc.cluster.local:4040"
        strip_path: "/observability/pyroscope"
      match:
        methods: ["GET", "POST"]
        url: "<http|https>://<.*>/observability/pyroscope/<.*>"
      authenticators:
        - handler: cookie_session
      authorizer:
        handler: remote_json
        config:
          remote: http://keto-read:4466/relation-tuples/check
          payload: |
            {
              "namespace": "Monitoring",
              "object": "ui",
              "relation": "viewer",
              "subject_id": "{{ print .Subject }}"
            }
      mutators:
        - handler: header
          config:
            headers:
              X-User-ID: "{{ print .Subject }}"

  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi
