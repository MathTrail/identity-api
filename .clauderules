# Identity & Context
You are working on mathtrail-identity — identity and access management built on the Ory stack.
This is a HYBRID repository: infrastructure (Ory services via Helm) + custom service (Identity UI SPA).
Ory stack: Kratos (identity), Hydra (OAuth2), Keto (permissions), Oathkeeper (API gateway).
Identity UI: React SPA that renders Ory self-service flows.

Tech Stack:
  UI: React 19, TypeScript, Vite 6, Tailwind CSS 4, shadcn/ui, Zustand
  Auth: Ory Kratos, Hydra, Keto, Oathkeeper (deployed via Helm)
  Build: Multi-stage Docker (Node 20 builder → nginx alpine)
Ports: 3000 (Vite dev), 8080 (nginx prod), 4433/4434 (Kratos), 4444/4445 (Hydra), 4466/4467 (Keto), 4455/4456 (Oathkeeper)
Infra: infra/helm/identity-ui/ + values/*.yaml for Ory components

# Communication Map
Inbound: Browser → Identity UI → Kratos APIs (via same-origin proxy)
Outbound: Kratos webhook → mathtrail-profile (POST registration event)
Publishes: `identity.registration.completed` (via Kratos webhook → Kafka)
Secrets (Vault): secret/data/{env}/mathtrail-identity/kratos-dsn, hydra-dsn

# Development Standards
- UI forms are built DYNAMICALLY from Kratos `ui.nodes` via Node.tsx — NEVER hardcode form fields
- Cookie-First Auth: always use `withCredentials: true`, HttpOnly cookies, no localStorage for tokens
- Same-Origin: Vite proxy (dev) and nginx proxy (prod) keep SPA and Kratos on same origin
- Use shadcn/ui components for all UI elements
- Use Zustand for auth state management (session, initialize action)
- Ory configs live in configs/ directory (identity.schema.json, namespaces.ts, access-rules.yaml)

# Commit Convention
Use Conventional Commits: feat(identity):, fix(identity):, feat(identity-ui):, fix(identity-ui):
Use "identity" scope for Ory infra changes, "identity-ui" for UI changes
Example: feat(identity-ui): add password recovery flow

# Testing Strategy
UI: `cd identity-ui && npm test` (Vitest)
Helm: `helm lint infra/helm/identity-ui/`
Integration: Manual testing of Ory flows (registration, login, consent)
Priority: UI component tests 60%, Ory integration tests 40%
